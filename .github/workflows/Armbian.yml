name: Armbian
on:
  push:
    branches:
      - dev
jobs:
  build:
    name: Armbian
    runs-on: ubuntu-latest
    steps:
     - name: ç¼–è¯‘å¼€å§‹é€šçŸ¥
       run: |
        curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=æˆ‘äº²çˆ±çš„âœ¨ä¸»äººâœ¨ï¼Œæ‚¨çš„Armbiané•œåƒå¼€å§‹ç¼–è¯‘å•¦ï¼" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"

     - name: æ£€æŸ¥
       uses: actions/checkout@v3
       

     - name: ç¼–è¯‘é•œåƒ
       run: |
        sudo ./compile.sh BOARD=arm-64 BRANCH=current RELEASE=bullseye BUILD_MINIMAL=yes BUILD_DESKTOP=no KERNEL_ONLY=no KERNEL_CONFIGURE=no COMPRESS_OUTPUTIMAGE=sha,img

     - name: æ‰“åŒ…é•œåƒ
       run: |
        xz -9ezvT0 output/images/*.img

     - name: ä¸Šä¼ é•œåƒ
       uses: actions/upload-artifact@main
       with:
         name: Armbian image
         path: output/images/*

     - name: åˆ›å»ºrelease tag
       id: tag
       run: |
        sudo timedatectl set-timezone Asia/Shanghai
        echo "::set-output name=release_tag::$(date +"%Y.%m.%d-%H%M")"

     - name: ä¸Šä¼ é•œåƒè‡³release
       uses: softprops/action-gh-release@v1
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
       with:
         tag_name: ${{ steps.tag.outputs.release_tag }}
         files: |
           output/images/*

     - name: åˆ é™¤è€æ—§æ„å»º
       uses: GitRML/delete-workflow-runs@main
       with: 
         retain_days: 1
         keep_minimum_runs: 3

     - name: åˆ é™¤è€æ—§release
       uses: dev-drprasad/delete-older-releases@v0.1.0
       with: 
         keep_latest: 3
         delete_tags: true
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

     - name: ç¼–è¯‘æˆåŠŸé€šçŸ¥
       run: |
        curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=æˆ‘äº²çˆ±çš„âœ¨ä¸»äººâœ¨ï¼Œæ‚¨çš„Armbiané•œåƒé¡ºåˆ©ç¼–è¯‘å®Œæˆå•¦ï¼ğŸ’" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
